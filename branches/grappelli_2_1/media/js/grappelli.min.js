var grappelli = {};

(function($) {
    grappelli.collapseHandlerClass = "collapse-handler";
    grappelli.collapsedBlockedClass = "collapse-blocked";
    grappelli.openAllClass = "open-handler";
    grappelli.closeAllClass = "close-handler";
    grappelli.collapseClass = "collapse";
    grappelli.closedClass = "closed";
    grappelli.openClass = "open";

    grappelli.collapseHandler = function() {
        if (!jQuery("body").hasClass(grappelli.collapsedBlockedClass)) {
            jQuery(this).parents("." + grappelli.collapseClass).first()
            .toggleClass(grappelli.closedClass)
            .toggleClass(grappelli.openClass);
        }
        return false;
    };

    grappelli.addCollapseHandlerClass = function() {
        $("." + this.collapseClass).each(function() {
            var node = $(this).children().first();
            if (node.is("h2") || node.is("h3") || node.is("h4")) {
                node.addClass(grappelli.collapseHandlerClass)
            }
        });
    };

    grappelli.registerCollapseHandler = function() {
        jQuery("." + this.collapseHandlerClass).click(this.collapseHandler);
    };


    grappelli.registerOpenAllHandler = function() {
        jQuery("." + this.openAllClass).click(this.openAllHandler);
    };

    /**
     * Open the collapseble and its child collapsebles
     */
    grappelli.openAllHandler = function() {
        jQuery(this).parents("." + grappelli.collapseClass)
                    .removeClass(grappelli.closedClass)
                    .addClass(grappelli.openClass)
                    .find("." + grappelli.collapseClass)
                    .removeClass(grappelli.closedClass)
                    .addClass(grappelli.openClass);
    };


    grappelli.registerCloseAllHandler = function() {
        jQuery("." + this.closeAllClass).click(this.closeAllHandler);
    };

    /**
     * Close the collapseble and its child collapsebles
     */
    grappelli.closeAllHandler = function() {
        jQuery(this).parents("." + grappelli.collapseClass)
                    .find("." + grappelli.collapseClass)
                    .removeClass(grappelli.openClass)
                    .addClass(grappelli.closedClass);
    };

    grappelli.initCollapseble = function() {
        grappelli.addCollapseHandlerClass();
        grappelli.registerCollapseHandler();

        grappelli.registerOpenAllHandler();
        grappelli.registerCloseAllHandler();
        
        $("." + grappelli.collapseClass + " ul.errorlist").each(function() {
            $(this).parents("." + grappelli.collapseClass)
                .removeClass(grappelli.closedClass)
                .addClass(grappelli.openClass);
        });
    };

    grappelli.initDateAndTimePicker = function() {
        $(".vDateField").datepicker({
            //appendText: '(mm/dd/yyyy)',
            showOn: 'button',
            buttonImageOnly: false,
            buttonText: '',
            dateFormat: 'yy-mm-dd'
        });
        $(".vTimeField").timepicker();
    };
    
    grappelli.initHacks = function() {
        $('p.datetime').each(function() {
            var text = $(this).html();
            text = text.replace(/^\w*: /, "");
            text = text.replace(/<br>.*: /, "<br>");
            $(this).html(text);
        });
    };
    
    $(document).ready(function() {
        // we do the hacks first!
        // because we manipulate dom via innerHTML => loose events
        grappelli.initHacks();
        grappelli.initCollapseble();
        grappelli.initDateAndTimePicker();
    });
})(jQuery.noConflict());
